fileVersion: 1
id: 573529a8-4c3a-431d-b909-432f99faa774
name: POLICY_PRODUCT_COMPUTED
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: ETL
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7d17b635-678f-444e-b6b0-1f0814f34893
          stepCounter: 573529a8-4c3a-431d-b909-432f99faa774
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: POLICY_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6bf5b50e-25c8-4142-b56e-cc0271e1f7ad
                stepCounter: 79dfbf33-c1f6-4e7a-927e-20ac33cc6670
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9a644282-b098-4520-8737-3c9e6cef8497
          stepCounter: 573529a8-4c3a-431d-b909-432f99faa774
        config: {}
        dataType: VARCHAR(8000)
        description: ""
        name: PROGRAM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4990b413-fe5c-4b93-975c-4010a4b179d0
                stepCounter: 5e972dcc-aa79-4240-9c44-83643a78cbdd
            transform: |-
              CASE 
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_POLICY_LINE_TYPE"."POLICY_LINE_TYPE_CODE")) IN ('CUMB', 'LXS', '1_BR1', 'IBR', 'BRI', '1_BRI', 'LENV', 'LUST', 'PRBM') THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'Client Advantage Products'
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_PROGRAM"."PROGRAM")) = 'CLIENT ADVANTAGE PRODUCTS' THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'Client Advantage Products'
                  ELSE NULL 
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 322c7cab-0224-49e4-b009-21cb9adcb0ef
          stepCounter: 573529a8-4c3a-431d-b909-432f99faa774
        config: {}
        dataType: VARCHAR(50)
        description: ""
        name: PRODUCT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cd73ac8f-0571-427c-a5f8-070786cd6c9e
                stepCounter: 4932fbe2-3b95-4dcf-8435-08b7aecca907
            transform: |-
              CASE 
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_POLICY_LINE_TYPE"."POLICY_LINE_TYPE_CODE")) IN ('CUMB', 'LXS') THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'Umbrella Advantage'
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_PROGRAM"."PROGRAM")) = 'CLIENT ADVANTAGE PRODUCTS' THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'MLP Direct'
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_POLICY_LINE_TYPE"."POLICY_LINE_TYPE_CODE")) IN ('1_BR1', 'IBR', 'BRI', '1_BRI') THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'Builders Risk'
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_POLICY_LINE_TYPE"."POLICY_LINE_TYPE_CODE")) IN ('LENV', 'LUST') THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'Contractors Pollution Protect'
                  WHEN MAX(CASE WHEN UPPER(TRIM("S_DIM_EPIC_POLICY_LINE_TYPE"."POLICY_LINE_TYPE_CODE")) IN ('PRBM') THEN 1 ELSE 0 END) OVER (PARTITION BY "S_DIM_LINE"."POLICY_KEY") = 1 THEN 'Equipment Breakdown'
                  ELSE NULL 
              END
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          POLICY_PRODUCT: 619d49bf-7286-4b45-a40d-f45188fa1faf
          S_DIM_EPIC_POLICY_LINE_TYPE: 4932fbe2-3b95-4dcf-8435-08b7aecca907
          S_DIM_EPIC_PROGRAM: 5e972dcc-aa79-4240-9c44-83643a78cbdd
          S_DIM_LINE: 79dfbf33-c1f6-4e7a-927e-20ac33cc6670
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: ETL
            nodeName: POLICY_PRODUCT
          - locationName: OS1_FDW
            nodeName: S_DIM_EPIC_POLICY_LINE_TYPE
          - locationName: OS1_FDW
            nodeName: S_DIM_EPIC_PROGRAM
          - locationName: OS1_FDW
            nodeName: S_DIM_LINE
        join:
          joinCondition: |-
            FROM {{ ref('ETL', 'POLICY_PRODUCT') }} "POLICY_PRODUCT"
            INNER JOIN {{ ref('OS1_FDW', 'S_DIM_LINE') }} "S_DIM_LINE"
            ON "POLICY_PRODUCT"."POLICY_KEY" = "S_DIM_LINE"."POLICY_KEY"
            AND "POLICY_PRODUCT"."POLICY_PROGRAM_PRODUCT_DISTINCT_CNT" > 1
            AND "POLICY_PRODUCT"."ADVANTAGE_PROGRAM_CNT" <> 1
            INNER JOIN {{ ref('OS1_FDW', 'S_DIM_EPIC_PROGRAM') }} "S_DIM_EPIC_PROGRAM"
            ON "S_DIM_LINE"."EPIC_PROGRAM_KEY" = "S_DIM_EPIC_PROGRAM"."EPIC_PROGRAM_KEY"
            AND IFNULL(UPPER(TRIM("S_DIM_EPIC_PROGRAM"."PRODUCT")), '') NOT IN ('','DO NOT USE')
            LEFT OUTER JOIN {{ ref('OS1_FDW', 'S_DIM_EPIC_POLICY_LINE_TYPE') }} "S_DIM_EPIC_POLICY_LINE_TYPE"
            ON "S_DIM_LINE"."AGENCY_SYSTEM_POLICY_TYPE" = "S_DIM_EPIC_POLICY_LINE_TYPE"."EPIC_POLICY_LINE_TYPE_KEY"
        name: POLICY_PRODUCT_COMPUTED
        noLinkRefs: []
  name: POLICY_PRODUCT_COMPUTED
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
